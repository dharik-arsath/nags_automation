<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Entry</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/8.1.0/mdb.min.css" rel="stylesheet" />
    <style>
        .form-outline input::-webkit-outer-spin-button,
        .form-outline input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .form-outline input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>

<body>
    <div class="container-fluid mt-3">
        <!-- Driver Information -->
        <div class="card mb-3">
            <div class="card-header py-2">
                <h5 class="mb-0">Driver Information</h5>
            </div>
            <div class="card-body">
                <div class="form-outline mb-3">
                    <input type="text" class="form-control active dropdown-toggle" id="buyer-user-name"
                        data-mdb-dropdown-init aria-expanded="false" autocomplete="off" autofocus>
                    <label class="form-label">Driver Name</label>

                    <!-- Dropdown menu -->
                    <ul class="dropdown-menu w-100" id="driver-dropdown" aria-labelledby="buyer-user-name">
                    </ul>
                </div>



                <div class="form-outline mb-3">
                    <input type="text" class="form-control active dropdown-toggle" id="buyer-lineid"
                        data-mdb-dropdown-init aria-expanded="false" autocomplete="off">
                    <label class="form-label">Area</label>

                    <!-- Dropdown menu -->
                    <ul class="dropdown-menu w-100" id="lineDropdown" aria-labelledby="buyer-lineid">
                    </ul>
                </div>



                <div class="form-outline mb-3">
                    <input type="date" class="form-control" id="date">
                    <label class="form-label">Date of Issue</label>
                </div>
            </div>
        </div>



        <!-- Add Product Button -->
        <div class="d-grid mb-3">
            <button class="btn btn-primary" id="product_add" data-mdb-ripple-init data-mdb-modal-init
                data-mdb-target="#addTodoModal" style="visibility: hidden;">
                <i class="fas fa-plus me-2"></i>Add Product
            </button>
        </div>

        <!-- Product List -->
        <div id="productList"></div>

        <!-- Add Product Modal -->
        <div class="modal fade" id="addTodoModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header py-2">
                        <h5 class="modal-title">Add New Product</h5>
                        <button type="button" class="btn-close" data-mdb-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="todoForm">
                            <div class="form-outline mb-3">
                                <input type="text" class="form-control active dropdown-toggle" id="product-input"
                                    data-mdb-dropdown-init aria-expanded="false" autocomplete="off">
                                <label class="form-label">Product Name</label>

                                <!-- Dropdown menu -->
                                <ul class="dropdown-menu w-100" id="productDropdown" aria-labelledby="product-input">
                                </ul>
                            </div>

                            <!-- Quantity Section -->
                            <div class="mb-3 p-2 bg-light rounded">
                                <small class="text-muted d-block mb-2">Quantity</small>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <div class="form-outline">
                                            <input type="number" class="form-control" id="editTodoCases" value="0"
                                                min="0">
                                            <label class="form-label">Cases</label>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="form-outline">
                                            <input type="number" class="form-control" id="editTodoPieces" value="0"
                                                min="0">
                                            <label class="form-label">Pieces</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Financial Section -->
                            <div class="mb-3 p-2 bg-light rounded">
                                <small class="text-muted d-block mb-2">Financial Details</small>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <div class="form-outline">
                                            <input type="number" class="form-control" id="editTodoDiscount" value="0"
                                                min="0" readonly>
                                            <label class="form-label">Discount</label>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="form-outline">
                                            <input type="number" class="form-control" id="editTodoCommission" value="0"
                                                min="0" readonly>
                                            <label class="form-label">Commission</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Adjustments Section -->
                            <div class="mb-3 p-2 bg-light rounded">
                                <small class="text-muted d-block mb-2">Adjustments</small>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <div class="form-outline mb-3">
                                            <input type="number" class="form-control" id="editTodoKuraivuCases"
                                                value="0" min="0">
                                            <label class="form-label">Kuraivu(in cases)</label>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="form-outline">
                                            <input type="number" class="form-control" id="editTodoKuraivuPieces"
                                                value="0" min="0">
                                            <label class="form-label">Kuraivu(in pieces)</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <div class="form-outline mb-3">
                                            <input type="number" class="form-control" id="editTodoAdhigaVaravuCases"
                                                value="0" min="0">
                                            <label class="form-label">Adhiga Varavu(in cases)</label>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="form-outline">
                                            <input type="number" class="form-control" id="editTodoAdhigaVaravuPieces"
                                                value="0" min="0">
                                            <label class="form-label">Adhiga Varavu(in pieces)</label>
                                        </div>
                                    </div>
                                </div>

                            </div>

                            <!-- Total Amount -->
                            <div class="form-outline mb-3">
                                <label class="form-label">Final Amount</label>
                                <input id="editTodoAmount" class="form-control" type="text" readonly>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-mdb-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="saveTodo()">Add Item</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-3" id="constant_expenses" style="visibility: hidden;">
            <div class="card-header py-2 d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Expenses</h5>
                <button class="btn btn-primary btn-sm" onclick="addExpenseRow()">
                    <i class="fas fa-plus me-2"></i>Add Expense
                </button>
            </div>
            <div class="card-body">
                <div id="expenses-container">
                </div>
            </div>
        </div>

        <!-- 
        <div class="card mb-3" style="visibility: hidden;" id="constant_expenses">
            <div class="card-header py-2 d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Expenses</h5>
                <button class="btn btn-primary btn-sm" onclick="addExpenseRow()">
                    <i class="fas fa-plus me-2"></i>Add Expense
                </button>
            </div>
            <div class="card-body">
                <div id="expenses-container">
                    <div class="expense-row mb-2 position-relative">
                        <div class="row g-2">
                            <div class="col-8">
                                <div class="form-outline mb-3">
                                    <input type="text" class="form-control expense-description active" value="Petrol">
                                    <label class="form-label">Description</label>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="form-outline mb-3">
                                    <input type="number" class="form-control expense-amount" value="0">
                                    <label class="form-label">Amount</label>
                                </div>
                            </div>
                            <div class="col-1">
                                <button class="btn btn-link text-danger p-0" onclick="removeExpenseRow(this)">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="expense-row mb-2 position-relative">

                        <div class="row g-2">
                            <div class="col-8">
                                <div class="form-outline mb-3">
                                    <input type="text" class="form-control expense-description active" value="Food">
                                    <label class="form-label">Description</label>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="form-outline mb-3">
                                    <input type="number" class="form-control expense-amount" value="0">
                                    <label class="form-label">Amount</label>
                                </div>
                            </div>
                            <div class="col-1">
                                <button class="btn btn-link text-danger p-0" onclick="removeExpenseRow(this)">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div> -->







        <!-- Summary Card -->
        <div class="card mb-3">
            <div class="card-header py-2">
                <h5 class="mb-0">Summary</h5>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-6">
                        <small class="text-muted">Total Products:</small>
                        <div id="totalProducts" class="h5 mb-0">₹0</div>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Total Deductions:</small>
                        <div id="totalDeductions" class="h5 mb-0 text-danger">₹0</div>
                    </div>
                    <div class="col-12">
                        <small class="text-muted">Final Amount:</small>
                        <div id="finalAmount" class="h4 mb-0 text-primary">₹0</div>
                    </div>
                </div>
            </div>
        </div>






        <!-- Submit Button -->
        <div class="d-grid mt-3" id="submitButtonContainer" style="visibility: hidden;">
            <button class="btn btn-primary" onclick="submitBillingDetails()" id="submitbtn">
                <i class="fas fa-save me-2"></i>Submit Details
            </button>
        </div>
    </div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/8.1.0/mdb.umd.min.js"></script>
    <!-- <script src="static/js/data.js"></script> -->
    <script src="{{url_for('static', filename='js/data.js')}}"></script>

    <script>
        // Call this after adding new expense rows and during initial load
        // document.addEventListener('DOMContentLoaded', initializeFormLabels);

        let todos = [];
        let currentId = 0;

        // Initialize date and form
        const localDate = new Date();
        document.getElementById('date').valueAsDate = new Date(localDate.getTime() - localDate.getTimezoneOffset() * 60000);
        document.querySelectorAll('.form-outline').forEach((formOutline) => {
            new mdb.Input(formOutline).init();
        });

        function updateAmount() {
            const productName = document.getElementById('product-input').value;
            const selectedProduct = products.find(product => product.name.toLowerCase() === productName);
            if (!selectedProduct) return;

            const caseCount = Number(document.getElementById("editTodoCases").value);
            const pieceCount = Number(document.getElementById("editTodoPieces").value);
            // const discount = Number(document.getElementById("editTodoDiscount").value);
            const discount = document.getElementById("editTodoDiscount").value = (caseCount * selectedProduct.discount.case) + (pieceCount * selectedProduct.discount.piece);
            // const commission = Number(document.getElementById("editTodoCommission").value);
            const kuraivu = Number(document.getElementById("editTodoKuraivuPieces").value);
            // const adhigaVaravu = Number(document.getElementById("editTodoAdhigaVaravu").value);

            const commission = document.getElementById("editTodoCommission").value = (caseCount * selectedProduct.commission.case) + (pieceCount * selectedProduct.commission.piece);
            // let totalAmount = (caseCount + pieceCount) * selectedProduct.price.case;
            let totalAmount = (caseCount * selectedProduct.price.case) + (pieceCount * selectedProduct.price.piece);
            totalAmount -= discount;
            totalAmount -= commission;

            totalAmount += (kuraivu * selectedProduct.kuraivu);

            document.getElementById('editTodoAmount').value = totalAmount.toFixed(2);
        }

        document.querySelector('[data-mdb-target="#addTodoModal"]').addEventListener('click', function (e) {
            const driverName = document.getElementById('buyer-user-name').value;
            if (!driverName.trim()) {
                e.preventDefault();
                alert('Please select driver name first');
                document.getElementById('buyer-user-name').classList.add('required-field');
            }
        });

        function updateSummary() {
            let totalBaseAmount = 0;
            let totalDiscounts = 0;
            let totalCommissions = 0;
            let totalKuraivu = 0;
            let totalAdhigaVaravu = 0;

            todos.forEach(todo => {
                // Calculate base amount
                const productInfo = products.find(p => p.name === todo.title);
                const basePriceCase = productInfo ? productInfo.price.case : 0;
                const basePricePiece = productInfo ? productInfo.price.piece : 0;
                const caseQuantity = Number(todo.cases);
                const pieceQuantity = Number(todo.pieces);

                const baseAmount = (caseQuantity * basePriceCase) + (pieceQuantity * basePricePiece);

                // Add to total base amount
                totalBaseAmount += baseAmount;

                // Calculate deductions
                totalDiscounts += Number(todo.discount) || 0;
                totalCommissions += Number(todo.commission) || 0;
                totalKuraivu += (Number(todo.kuraivu_pieces) * (productInfo ? productInfo.kuraivu : 0)) || 0;
            });

            // Add constant expenses
            // Get total expenses
            const constantExpenses = getExpensesTotal();

            // Calculate total deductions
            const totalDeductions = totalDiscounts + totalCommissions + constantExpenses;

            // Calculate final amount
            const finalAmount = totalBaseAmount - totalDeductions + totalKuraivu;

            // Update display with detailed breakdown
            document.getElementById('totalProducts').innerHTML = `
        <div class="h5 mb-0">₹${totalBaseAmount.toFixed(2)}</div>
    `;

            document.getElementById('totalDeductions').innerHTML = `
        <div class="h5 mb-0 text-danger">₹${totalDeductions.toFixed(2)}</div>
        <div class="small text-muted">
            ${totalDiscounts > 0 ? `Discounts: ₹${totalDiscounts.toFixed(2)}<br>` : ''}
            ${totalCommissions > 0 ? `Commissions: ₹${totalCommissions.toFixed(2)}<br>` : ''}
            ${constantExpenses > 0 ? `Expenses: ₹${constantExpenses.toFixed(2)}<br>` : ''}
            ${totalAdhigaVaravu > 0 ? `<span class="text-success">Adhiga Varavu: +₹${totalAdhigaVaravu.toFixed(2)}</span>` : ''}
        </div>
    `;

            document.getElementById('finalAmount').innerHTML = `
        <div class="h4 mb-0 text-primary">₹${finalAmount.toFixed(2)}</div>
    `;
        }


        // Modify your existing updateList function to call updateSummary:
        const originalUpdateList = updateList;
        updateList = function () {
            originalUpdateList();
            updateSummary();
        };




        function saveTodo() {
            const driverName = document.getElementById('buyer-user-name').value;
            if (!driverName.trim()) {
                alert('Please select driver name first');
                document.getElementById('buyer-user-name').classList.add('required-field');
                closeModal('addTodoModal');
                return;
            }

            const productInfo = products.find(p => p.name === document.getElementById('product-input').value);
            const basePriceCase = productInfo ? productInfo.price.case : 0;
            const basePricePiece = productInfo ? productInfo.price.piece : 0;

            // const totalQuantity = Number(document.getElementById("editTodoCases").value) + Number(document.getElementById("editTodoPieces").value);
            const totalQuantityCases = Number(document.getElementById("editTodoCases").value);
            const totalQuantityPieces = Number(document.getElementById("editTodoPieces").value);

            const baseAmount = (basePriceCase * totalQuantityCases) + (basePricePiece * totalQuantityPieces);


            // const kuraivuAmount = document.getElementById("editTodoKuraivuPieces").value * productInfo.price.piece;
            const kuraivuAmount = document.getElementById("editTodoKuraivuPieces").value * productInfo.kuraivu;

            const formData = {
                title: document.getElementById('product-input').value,
                line: document.getElementById('buyer-lineid').value,
                cases: document.getElementById("editTodoCases").value,
                pieces: document.getElementById("editTodoPieces").value,
                discount: document.getElementById("editTodoDiscount").value,
                commission: document.getElementById("editTodoCommission").value,
                kuraivu_pieces: document.getElementById("editTodoKuraivuPieces").value,
                kuraivu_cases: document.getElementById("editTodoKuraivuCases").value,
                kuraivu_amount: kuraivuAmount,
                adhigaVaravu_cases: document.getElementById("editTodoAdhigaVaravuCases").value,
                adhigaVaravu_pieces: document.getElementById("editTodoAdhigaVaravuPieces").value,
                amount: document.getElementById("editTodoAmount").value,
                base_amount: baseAmount
            };
            if (formData.title) {
                todos.push({ id: currentId++, ...formData });
                updateList();
                document.getElementById('todoForm').reset();
                closeModal('addTodoModal');
            }
        }
        function deleteTodo(id) {
            if (confirm('Delete this item?')) {
                todos = todos.filter(t => t.id !== id);
                updateList();
            }
        }

        function updateList() {
            const list = document.getElementById('productList');
            list.innerHTML = todos.map(todo => {
                // Calculate base amount before any deductions
                const productInfo = products.find(p => p.name === todo.title);
                const basePrice_case = productInfo ? productInfo.price.case : 0;
                const basePrice_piece = productInfo ? productInfo.price.piece : 0;

                const case_quantity = Number(todo.cases);
                const piece_quantity = Number(todo.pieces);

                const baseAmount = (case_quantity * basePrice_case) + (piece_quantity * basePrice_piece)

                // Calculate deductions and additions
                const totalDeductions = Number(todo.discount) + Number(todo.commission)
                const totalAdditions = Number(todo.kuraivu_pieces) * (productInfo ? productInfo.kuraivu : 0);

                return `
        <div class="card mb-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h3 class="mb-0">${todo.title}</h3>
                    <button class="btn btn-link btn-sm text-danger p-0" onclick="deleteTodo(${todo.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                
                <!-- Basic Information -->
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <small class="text-muted">Area:</small>
                        <div>${todo.line}</div>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Quantity:</small>
                        <div>${todo.cases} cases + ${todo.pieces} pieces</div>
                    </div>
                </div>

                <!-- Financial Breakdown -->
                <div class="border-top pt-2">
                    <div class="row g-2">
                        <!-- Base Amount -->
                        <div class="col-12">
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">Base Amount:</small>
                                <div class="fw-bold">₹${baseAmount.toFixed(2)}</div>
                            </div>
                        </div>

                        <!-- Deductions Section -->
                        <div class="col-12">
                            <small class="text-muted d-block mb-1">Deductions:</small>
                            <div class="ms-3">
                                ${Number(todo.discount) > 0 ? `
                                <div class="d-flex justify-content-between text-danger">
                                    <span>Discount</span>
                                    <span>-₹${Number(todo.discount).toFixed(2)}</span>
                                </div>` : ''}
                                
                                ${Number(todo.commission) > 0 ? `
                                <div class="d-flex justify-content-between text-danger">
                                    <span>Commission</span>
                                    <span>-₹${Number(todo.commission).toFixed(2)}</span>
                                </div>` : ''}
                                
                                ${Number(todo.kuraivu) > 0 ? `
                                <div class="d-flex justify-content-between text-danger">
                                    <span>Kuraivu (${todo.kuraivu} pieces)</span>
                                    <span>-₹${(Number(todo.kuraivu) * (productInfo ? productInfo.price.piece : 0)).toFixed(2)}</span>
                                </div>` : ''}
                            </div>
                        </div>

                        <!-- Additions Section -->
                        ${Number(todo.kuraivu_pieces) > 0 ? `
                        <div class="col-12">
                            <small class="text-muted d-block mb-1">Additions:</small>
                            <div class="ms-3">
                                <div class="d-flex justify-content-between text-success">
                                    <span>Kuraivu (${todo.kuraivu_pieces} pieces)</span>
                                    <span>+₹${totalAdditions.toFixed(2)}</span>
                                </div>
                            </div>
                        </div>` : ''}

                        <!-- Final Amount -->
                        <div class="col-12 mt-2 border-top pt-2">
                            <div class="d-flex justify-content-between">
                                <small class="text-muted fw-bold">Final Amount:</small>
                                <div class="text-primary fw-bold">₹${todo.amount}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        `;
            }).join('');

            const submitButton = document.getElementById('submitButtonContainer');
            submitButton.style.visibility = todos.length > 0 ? 'visible' : 'hidden';

            const constant_expenses = document.getElementById("constant_expenses");
            constant_expenses.style.visibility = todos.length > 0 ? 'visible' : 'hidden';

            // Update summary after updating list
            updateSummary();
        }



        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            const modalInstance = mdb.Modal.getInstance(modal);
            modalInstance.hide();
        }

        // Event listeners for amount calculation
        ['product-input', 'editTodoCases', 'editTodoPieces', 'editTodoDiscount',
            'editTodoCommission', 'editTodoKuraivuPieces']
            .forEach(id => {
                document.getElementById(id).addEventListener('input', updateAmount);
            });


        document.getElementById('buyer-user-name').addEventListener('input', function () {
            this.classList.remove('required-field');
            const name = document.getElementById('buyer-user-name').value
            console.log(name)
            if (!name) {
                document.getElementById("product_add").style.visibility = "hidden";
            }
            if (name.length > 0) {
                document.getElementById("product_add").style.visibility = "visible";
            }
        });





        // Add expense row functionality
        //     function addExpenseRow() {
        //         const container = document.getElementById('expenses-container');
        //         const newRow = document.createElement('div');
        //         newRow.className = 'expense-row mb-2 position-relative';
        //         newRow.innerHTML = `
        //                     <div class="row g-2">
        //                         <div class="col-8">
        //                             <div class="form-outline mb-3">
        //                                 <input type="text" list="expenseOptions"
        //                                     class="form-control expense-description active">
        //                                 <label class="form-label">Description</label>
        //                                 <datalist id="expenseOptions">
        //                                     <option value="Petrol">
        //                                     <option value="Food">
        //                                     <option value="Puncture">
        //                                     <option value="Key">
        //                                     <option value="Vehicle repair">
        //                                 </datalist>
        //                             </div>
        //                         </div>
        //                         <div class="col-3">
        //                             <div class="form-outline mb-3">
        //                                 <input type="number" class="form-control expense-amount" value="0">
        //                                 <label class="form-label">Amount</label>
        //                             </div>
        //                         </div>
        //                         <div class="col-1">
        //                             <button class="btn btn-link text-danger p-0" onclick="removeExpenseRow(this)">
        //                                 <i class="fas fa-times"></i>
        //                             </button>
        //                         </div>
        //                     </div>
        // `;

        //         container.appendChild(newRow);

        //         newRow.querySelectorAll('.form-outline').forEach((formOutline) => {
        //             new mdb.Input(formOutline).init();
        //         });
        //         // // initializeFormLabels(); // Add this line
        //     }


        function addExpenseRow() {
            const container = document.getElementById('expenses-container');
            const newRow = document.createElement('div');
            newRow.className = 'expense-row mb-2 position-relative';
            newRow.innerHTML = `
                        <div class="row g-2">
                            <div class="col-8">
                                <div class="form-outline mb-3">
                                    <input type="text"
                                    class="form-control expense-description active dropdown-toggle" data-mdb-dropdown-init aria-expanded="false" autocomplete="off" id="expenseOptions">
                                    <label class="form-label">Description</label>


                                    <ul class="dropdown-menu w-100" id="expenseDropdown" aria-labelledby="expenseOptions">
                                        <li><a class="dropdown-item" >Petrol</a></li>
                                        <li><a class="dropdown-item" >Food</a></li>
                                        <li><a class="dropdown-item" >Puncture</a></li>
                                        <li><a class="dropdown-item" >Key</a></li>
                                        <li><a class="dropdown-item" >Vehicle_Repair</a></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="form-outline mb-3">
                                    <input type="number" class="form-control expense-amount" value="0">
                                    <label class="form-label">Amount</label>
                                </div>
                            </div>
                            <div class="col-1">
                                <button class="btn btn-link text-danger p-0" onclick="removeExpenseRow(this)">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
    `;

            container.appendChild(newRow);

            newRow.querySelectorAll('.form-outline').forEach((formOutline) => {
                new mdb.Input(formOutline).init();
            });
            const dropdownInputs = newRow.querySelectorAll('.dropdown-toggle');
            dropdownInputs.forEach(input => {
                new mdb.Dropdown(input); // Initialize the dropdown for dynamically added inputs
            });


            // Add event listener for dropdown item click
            const expenseOptionsMenu = newRow.querySelector('#expenseDropdown');
            const expenseOptionInput = newRow.querySelector('#expenseOptions');

            expenseOptionsMenu.addEventListener("click", (e) => {
                if (e.target && e.target.matches('.dropdown-item')) {
                    // Set input value to the clicked item's text content
                    expenseOptionInput.value = e.target.textContent.trim();

                    // Optionally, you can hide the dropdown after selection
                    expenseOptionsMenu.classList.remove('show'); // Close the dropdown after selection
                }
            });
        }



        function removeExpenseRow(button) {
            if (document.querySelectorAll('.expense-row').length > 0) {
                button.closest('.expense-row').remove();
                updateSummary();
            }
        }



        // Modify updateSummary() to handle dynamic expenses
        function getExpensesTotal() {
            let total = 0;
            document.querySelectorAll('.expense-amount').forEach(input => {
                total += parseFloat(input.value) || 0;
            });
            return total;
        }


        // Add event listener for expense amounts
        document.addEventListener('input', function (e) {
            if (e.target.classList.contains('expense-amount')) {
                updateSummary();
            }
        });






        function submitBillingDetails() {
            const submitbtn = document.getElementById("submitbtn");

            submitbtn.style.visibility = "hidden";

            const driverName = document.getElementById('buyer-user-name').value;
            const date = document.getElementById('date').value;
            // const diesel = document.getElementById("dieselExpense").value;
            // const vehicleDamage = document.getElementById("vehicleDamage").value;
            // const otherExpenseAmount = document.getElementById("otherExpenseAmount").value;
            // const otherExpenseDescription = document.getElementById("otherExpenses").value;


            const expenses = {};
            document.querySelectorAll('.expense-row').forEach(row => {
                const description = row.querySelector('.expense-description').value;
                const amount = parseFloat(row.querySelector('.expense-amount').value) || 0;
                if (description || amount > 0) {
                    expenses[description] = amount;
                }
            });
            console.log(expenses)



            const localTime = new Date()
            const timeStr = `${localTime.getHours().toString().padStart(2, '0')}:${localTime.getMinutes().toString().padStart(2, '0')}`;

            // Create array to store all billing entries
            const billingEntries = todos.map(todo => ({
                driver_name: driverName,
                date: date,
                time: timeStr,
                product_name: todo.title,
                line: todo.line,
                cases: Number(todo.cases),
                pieces: Number(todo.pieces),
                discount: Number(todo.discount),
                commission: Number(todo.commission),
                kuraivu_cases: Number(todo.kuraivu_cases),
                kuraivu_pieces: Number(todo.kuraivu_pieces),
                kuraivu_amount: Number(todo.kuraivu_amount),
                adhiga_varavu_cases: Number(todo.adhigaVaravu_cases),
                adhiga_varavu_pieces: Number(todo.adhigaVaravu_pieces),
                base_amount: Number(todo.base_amount),
                final_amount: Number(todo.amount),
                // final_amount: Number(todo.amount),
                // diesel: Number(diesel),
                // vehicle_damage: Number(vehicleDamage),
                // other_expense: Number(otherExpenseAmount),
                // other_expense_description: otherExpenseDescription
            }));

            // Prepare final payload
            const payload = {
                entries: billingEntries,
                expenses: expenses
            };

            const isDevelopment = window.location.hostname === 'localhost' || window.location.hostname === "127.0.0.1"

            const baseUrl = isDevelopment ? 'http://localhost:8000/' : 'https://nagaraj1.pythonanywhere.com/';

            // Submit to server
            fetch(baseUrl + "update_sheet", {
                // fetch("https://dharikarsath01.pythonanywhere.com/update_sheet", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(payload)
            })
                .then(response => {
                    if (!response.ok) {
                        submitButton.style.visibility = 'visible';
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (isDevelopment) {
                        window.location.replace("thankyou.html")
                    } else {
                        window.location.replace("thankyou")
                    }
                })
                .catch(error => {
                    console.error("Error submitting billing details:", error);
                    alert("Failed to submit billing details. Please try again.");
                    submitbtn.style.visibility = 'visible';
                });
        }

        function filterArea(query) {
            return lineListInfo.filter(line => line.line.toLowerCase().includes(query.toLowerCase()));
        }

        // Handle user input and update dropdown
        const lineName = document.getElementById('buyer-lineid');
        const lineMenu = document.getElementById('lineDropdown');

        // Render all items by default
        function renderLineDropdown() {
            lineMenu.innerHTML = '';  // Clear existing items
            lineListInfo.forEach(line => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `<a class="dropdown-item" href="#">${line.line.toLowerCase()}</a>`;
                lineMenu.appendChild(listItem);
            });
        }



        // // Initial render of all items
        // // renderAllItems();
        lineName.addEventListener("click", () => {
            renderLineDropdown();
        })

        lineName.addEventListener('input', function () {
            const query = lineName.value.trim().toLowerCase();

            if (query.length === 0) {
                renderLineDropdown(); // Show all items if no input
                return;
            }

            const matches = filterArea(query);
            lineMenu.innerHTML = '';  // Clear the dropdown

            matches.forEach(match => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `<a class="dropdown-item" href="#">${match.line}</a>`;
                lineMenu.appendChild(listItem);
            });
        });

        // Handle dropdown item selection
        lineMenu.addEventListener('click', function (e) {
            if (e.target && e.target.matches('.dropdown-item')) {
                lineName.value = e.target.textContent.trim();
                lineMenu.innerHTML = '';  // Close dropdown after selection

                document.getElementById('buyer-lineid').dispatchEvent(new Event('input'));
            }
        });


















        function filterDrivers(query) {
            return driverListInfo.filter(driver => driver.name.toLowerCase().includes(query.toLowerCase()));
        }

        // Handle user input and update dropdown
        const driverName = document.getElementById('buyer-user-name');
        const driverMenu = document.getElementById('driver-dropdown');

        // Render all items by default
        function renderDriversDropdown() {
            driverMenu.innerHTML = '';  // Clear existing items
            driverListInfo.forEach(driver => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `<a class="dropdown-item" href="#">${driver.name.toLowerCase()}</a>`;
                driverMenu.appendChild(listItem);
            });
        }

        // // Initial render of all items
        // // renderAllItems();
        driverName.addEventListener("click", () => {
            renderDriversDropdown();
        })

        driverName.addEventListener('input', function () {
            const query = driverName.value.trim().toLowerCase();

            if (query.length === 0) {
                renderDriversDropdown(); // Show all items if no input
                return;
            }

            const matches = filterDrivers(query);
            console.log(matches)
            driverMenu.innerHTML = '';  // Clear the dropdown

            matches.forEach(match => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `<a class="dropdown-item" href="#">${match.name}</a>`;
                driverMenu.appendChild(listItem);
            });
        });

        // Handle dropdown item selection
        driverMenu.addEventListener('click', function (e) {
            if (e.target && e.target.matches('.dropdown-item')) {
                driverName.value = e.target.textContent.trim();
                driverMenu.innerHTML = '';  // Close dropdown after selection

                document.getElementById('buyer-user-name').dispatchEvent(new Event('input'));
            }
        });


    </script>





    <script>
        // TrieNode and Trie implementation
        class TrieNode {
            constructor() {
                this.children = {};
                this.isEndOfWord = false;
            }
        }

        class Trie {
            constructor() {
                this.root = new TrieNode();
            }

            insert(word) {
                let node = this.root;
                for (let char of word) {
                    if (!node.children[char]) {
                        node.children[char] = new TrieNode();
                    }
                    node = node.children[char];
                }
                node.isEndOfWord = true;
            }

            findWordsWithPrefix(prefix) {
                let node = this.root;
                for (let char of prefix) {
                    if (!node.children[char]) {
                        return [];
                    }
                    node = node.children[char];
                }
                return this._collectWords(node, prefix);
            }

            _collectWords(node, prefix) {
                let words = [];
                if (node.isEndOfWord) {
                    words.push(prefix);
                }
                for (let char in node.children) {
                    words = words.concat(this._collectWords(node.children[char], prefix + char));
                }
                return words;
            }
        }

        // Initialize the Trie and insert products
        // const products2 = ["product 1", "product 2", "product 3", "product 4", "other products"];
        const trie = new Trie();
        products.forEach(product => {
            trie.insert(product.name.toLowerCase())
        }
        );

        // Handle user input and update dropdown
        const input = document.getElementById('product-input');
        const dropdownMenu = document.getElementById('productDropdown');

        // Render all items by default
        function renderAllItems() {
            dropdownMenu.innerHTML = '';  // Clear existing items
            products.forEach(product => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `<a class="dropdown-item" href="#">${product.name.toLowerCase()}</a>`;
                dropdownMenu.appendChild(listItem);
            });
        }

        // Initial render of all items
        // renderAllItems();
        input.addEventListener("click", () => {
            renderAllItems();
        })

        input.addEventListener('input', function () {
            const query = input.value.trim().toLowerCase();

            if (query.length === 0) {
                renderAllItems(); // Show all items if no input
                return;
            }

            const matches = trie.findWordsWithPrefix(query);

            dropdownMenu.innerHTML = '';  // Clear the dropdown

            matches.forEach(match => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `<a class="dropdown-item" href="#">${match}</a>`;
                dropdownMenu.appendChild(listItem);
            });
        });

        // Handle dropdown item selection
        dropdownMenu.addEventListener('click', function (e) {
            if (e.target && e.target.matches('.dropdown-item')) {
                input.value = e.target.textContent.trim();
                dropdownMenu.innerHTML = '';  // Close dropdown after selection
            }
        });

    </script>


</body>

</html>