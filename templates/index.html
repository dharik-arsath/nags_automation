<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Entry</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/8.1.0/mdb.min.css" rel="stylesheet" />
    <style>
        .form-outline input::-webkit-outer-spin-button,
        .form-outline input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .form-outline input[type=number] {
            -moz-appearance: textfield;
        }

        .w-100px {
            width: 100px !important;
        }
    </style>
</head>

<body>
    <div class="container-fluid mt-3">
        <!-- Driver Information -->
        <div class="card mb-3">
            <div class="card-header py-2">
                <h5 class="mb-0">Driver Information</h5>
            </div>
            <div class="card-body">
                <div class="form-outline mb-3">
                    <input type="text" class="form-control active dropdown-toggle" id="buyer-user-name"
                        data-mdb-dropdown-init aria-expanded="false" autocomplete="off" autofocus>
                    <label class="form-label">Driver Name</label>

                    <!-- Dropdown menu -->
                    <ul class="dropdown-menu w-100" id="driver-dropdown" aria-labelledby="buyer-user-name">
                    </ul>
                </div>



                <div class="form-outline mb-3">
                    <input type="text" class="form-control active dropdown-toggle" id="buyer-lineid"
                        data-mdb-dropdown-init aria-expanded="false" autocomplete="off">
                    <label class="form-label">Area</label>

                    <!-- Dropdown menu -->
                    <ul class="dropdown-menu w-100" id="lineDropdown" aria-labelledby="buyer-lineid">
                    </ul>
                </div>



                <div class="form-outline mb-3">
                    <input type="date" class="form-control" id="date">
                    <label class="form-label">Date of Issue</label>
                </div>
            </div>
        </div>



        <!-- Add Product Button -->
        <div class="d-grid mb-3">
            <button class="btn btn-primary" id="product_add" data-mdb-ripple-init data-mdb-modal-init
                data-mdb-target="#addTodoModal" style="visibility: hidden;">
                <i class="fas fa-plus me-2"></i>Add Product
            </button>
        </div>

        <!-- Product List -->
        <div id="productList"></div>

        <!-- Add Product Modal -->
        <div class="modal fade" id="addTodoModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header py-2">
                        <h5 class="modal-title">Add New Product</h5>
                        <button type="button" class="btn-close" data-mdb-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="todoForm">
                            <div class="p-2 bg-light rounded">
                                <div class="row g-2">
                                    <div class="col-12">
                                        <div class="form-outline mb-3">
                                            <input type="text" class="form-control active dropdown-toggle"
                                                id="product-input" data-mdb-dropdown-init aria-expanded="false"
                                                autocomplete="off">
                                            <label class="form-label">Product Name</label>

                                            <!-- Dropdown menu -->
                                            <ul class="dropdown-menu w-100" id="productDropdown"
                                                aria-labelledby="product-input">
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>




                            <!-- Goods Upload Section -->
                            <div class="mb-3 p-2 bg-light rounded">
                                <small class="text-muted d-block mb-2">Goods Upload</small>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <div class="form-outline">
                                            <input type="number" class="form-control active" id="goods_up_cases" min="0"
                                            onkeypress="return event.charCode >= 48 && event.charCode <= 57">
                                            <label class="form-label">Goods Upload Cases</label>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="form-outline">
                                            <input type="number" class="form-control active" id="goods_up_pieces"
                                                min="0" max="24" onkeypress="return event.charCode >= 48 && event.charCode <= 57">
                                            <label class="form-label">Goods Upload Pieces</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Goods Return Section -->
                            <div class="mb-3 p-2 bg-light rounded">
                                <small class="text-muted d-block mb-2">Goods Return</small>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <div class="form-outline">
                                            <input type="number" class="form-control active" id="goods_ret_cases" min="0" 
                                            onkeypress="return event.charCode >= 48 && event.charCode <= 57">
                                            <label class="form-label">Goods Return Cases</label>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="form-outline">
                                            <input type="number" class="form-control active" id="goods_ret_pieces"
                                                min="0" max="24" onkeypress="return event.charCode >= 48 && event.charCode <= 57"
                                                oninput="validatePieces(this)">
                                            <label class="form-label">Goods Return Pieces</label>
                                        </div>
                                    </div>
                                </div>
                            </div>




                            <!-- Sales Section -->
                            <div class="mb-3 p-2 bg-light rounded">
                                <small class="text-muted d-block mb-2">Sales</small>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <div class="form-outline">
                                            <input type="number" class="form-control active" id="editTodoCases" min="0" 
                                            onkeypress="return event.charCode >= 48 && event.charCode <= 57" disabled>
                                            <label class="form-label">Cases</label>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="form-outline">
                                            <input type="number" class="form-control active" id="editTodoPieces"
                                                min="0" onkeypress="return event.charCode >= 48 && event.charCode <= 57" disabled>
                                            <label class="form-label">Pieces</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Discount Section -->
                            <div class="mb-3 p-2 bg-light rounded">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small class="text-muted">Discounts</small>
                                    <button type="button" class="btn btn-primary btn-sm w-100px" onclick="addDiscountRow()">
                                        <i class="fas fa-plus me-2"></i>Add
                                    </button>
                                </div>
                                <div id="discounts-container"></div>
                            </div>



                            <!-- Gain Section -->
                            <div class="mb-3 p-2 bg-light rounded">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small class="text-muted">Gains</small>
                                    <button type="button" class="btn btn-primary btn-sm w-100px" onclick="addGainRow()">
                                        <i class="fas fa-plus me-2"></i>Add
                                    </button>
                                </div>
                                <div id="gains-container"></div>
                            </div>

                            <!-- Commission Section -->
                            <div class="mb-3 p-2 bg-light rounded">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small class="text-muted">Commissions</small>
                                    <button type="button" class="btn btn-primary btn-sm w-100px" onclick="addCommissionRow()">
                                        <i class="fas fa-plus me-2"></i>Add
                                    </button>
                                </div>
                                <div id="commissions-container"></div>
                            </div>

                            <!-- Financial Section -->
                            <div class="mb-3 p-2 bg-light rounded">
                                <small class="text-muted d-block mb-2">Financial Details</small>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <div class="form-outline">
                                            <input type="number" class="form-control" id="editTodoDiscount" value="0"
                                                min="0" readonly>
                                            <label class="form-label">Discount</label>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="form-outline">
                                            <input type="number" class="form-control" id="editTodoCommission" value="0"
                                                min="0" readonly>
                                            <label class="form-label">Commission</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Adjustments Section -->
                            <div class="mb-3 p-2 bg-light rounded">
                                <small class="text-muted d-block mb-2">Adjustments</small>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <div class="form-outline mb-3">
                                            <input type="number" class="form-control active" id="editTodoKuraivuCases"
                                                min="0">
                                            <label class="form-label">Kuraivu(in cases)</label>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="form-outline">
                                            <input type="number" class="form-control active" id="editTodoKuraivuPieces"
                                                min="0">
                                            <label class="form-label">Kuraivu(in pieces)</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <div class="form-outline mb-3">
                                            <input type="number" class="form-control active"
                                                id="editTodoAdhigaVaravuCases" min="0">
                                            <label class="form-label">Adhiga Varavu(in cases)</label>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="form-outline">
                                            <input type="number" class="form-control active"
                                                id="editTodoAdhigaVaravuPieces" min="0">
                                            <label class="form-label">Adhiga Varavu(in pieces)</label>
                                        </div>
                                    </div>
                                </div>

                            </div>

                            <!-- Total Amount -->
                            <div class="form-outline mb-3">
                                <label class="form-label">Final Amount</label>
                                <input id="editTodoAmount" class="form-control" type="text" readonly>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-mdb-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="saveTodo()">Add Item</button>
                    </div>
                </div>
            </div>
        </div>


        <!-- Add this after the expenses card and before the summary card -->
        <div class="card mb-3" id="credit-section", style="visibility: hidden;">
            <div class="card-header py-2">
                <h5 class="mb-0">Credits</h5>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-6">
                        <div class="form-outline">
                            <input type="number" class="form-control active credit-amount" id="creditPayable" min="0">
                            <label class="form-label">Credit as Payable</label>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="form-outline">
                            <input type="number" class="form-control active credit-amount" id="creditReceivable" min="0">
                            <label class="form-label">Credit as Receivable</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-3" id="constant_expenses" style="visibility: hidden;">
            <div class="card-header py-2 d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Expenses</h5>
                <button class="btn btn-primary btn-sm" onclick="addExpenseRow()">
                    <i class="fas fa-plus me-2"></i>Add Expense
                </button>
            </div>
            <div class="card-body">
                <div id="expenses-container">
                </div>
            </div>
        </div>

        <!-- Summary Card -->
        <div class="card mb-3">
            <div class="card-header py-2">
                <h5 class="mb-0">Summary</h5>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-6">
                        <small class="text-muted">Total Products:</small>
                        <div id="totalProducts" class="h5 mb-0">₹0</div>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Total Deductions:</small>
                        <div id="totalDeductions" class="h5 mb-0 text-danger">₹0</div>
                    </div>
                    <div class="col-12">
                        <small class="text-muted">Final Amount:</small>
                        <div id="finalAmount" class="h4 mb-0 text-primary">₹0</div>
                    </div>
                </div>
            </div>
        </div>






        <!-- Submit Button -->
        <div class="d-grid mt-3" id="submitButtonContainer" style="visibility: hidden;">
            <button class="btn btn-primary" onclick="submitBillingDetails()" id="submitbtn">
                <i class="fas fa-save me-2"></i>Submit Details
            </button>
        </div>
    </div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/8.1.0/mdb.umd.min.js"></script>
    <script src="static/js/data.js"></script>
    <!-- <script src="{{url_for('static', filename='js/data.js')}}"></script> -->
    <!-- <script src="{{url_for('static', filename='js/validator.js')}}"></script> -->
    <script>
        // Call this after adding new expense rows and during initial load
        // document.addEventListener('DOMContentLoaded', initializeFormLabels);

        let todos = [];
        let currentId = 0;

        // Cache DOM elements
        const DOM = {
            // Input fields
            inputs: {
                driverName: document.getElementById('buyer-user-name'),
                area: document.getElementById('buyer-lineid'),
                date: document.getElementById('date'),
                product: document.getElementById('product-input'),
                goodsUpCases: document.getElementById('goods_up_cases'),
                goodsUpPieces: document.getElementById('goods_up_pieces'),
                goodsRetCases: document.getElementById('goods_ret_cases'),
                goodsRetPieces: document.getElementById('goods_ret_pieces'),
                salesCases: document.getElementById('editTodoCases'),
                salesPieces: document.getElementById('editTodoPieces'),
                discount: document.getElementById('editTodoDiscount'),
                commission: document.getElementById('editTodoCommission'),
                kuraivuCases: document.getElementById('editTodoKuraivuCases'),
                kuraivuPieces: document.getElementById('editTodoKuraivuPieces'),
                adhigaVaravuCases: document.getElementById('editTodoAdhigaVaravuCases'),
                adhigaVaravuPieces: document.getElementById('editTodoAdhigaVaravuPieces'),
                amount: document.getElementById('editTodoAmount'),
                creditPayable: document.getElementById('creditPayable'),
                creditReceivable: document.getElementById('creditReceivable')
            },
            // Dropdowns
            dropdowns: {
                driver: document.getElementById('driver-dropdown'),
                line: document.getElementById('lineDropdown'),
                product: document.getElementById('productDropdown'),
            },
            // Containers
            containers: {
                productList: document.getElementById('productList'),
                expenses: document.getElementById('expenses-container'),
                discounts: document.getElementById('discounts-container'),
                gains: document.getElementById('gains-container'),
                commissions: document.getElementById('commissions-container'),
                constantExpenses: document.getElementById('constant_expenses'),
                creditSection: document.getElementById("credit-section")
            },
            // Buttons
            buttons: {
                productAdd: document.getElementById('product_add'),
                submit: document.getElementById('submitbtn')
            },
            // Summary elements
            summary: {
                totalProducts: document.getElementById('totalProducts'),
                totalDeductions: document.getElementById('totalDeductions'),
                finalAmount: document.getElementById('finalAmount')
            },
            modals: {
                addTodoModal: document.getElementById('addTodoModal'),
                // add other modals here if needed
            },
            forms: {
                todo: document.getElementById('todoForm')
            }
        };

        // Initialize date and form
        const localDate = new Date();
        DOM.inputs.date.valueAsDate = new Date(localDate.getTime() - localDate.getTimezoneOffset() * 60000);
        document.querySelectorAll('.form-outline').forEach((formOutline) => {
            new mdb.Input(formOutline).init();
        });

        function getSelectedProduct() {
            const productName = DOM.inputs.product.value.trim().toLowerCase();
            
            const matchingProducts = products.filter(product =>
                product.name.toLowerCase() === productName
            );

            if (matchingProducts.length > 0) {
                return matchingProducts[0];
            } else {
                console.warn('No products found for the selected name.');
                return null;
            }
        }

        function getGoodsData() {
            return {
                up_cases: Number(DOM.inputs.goodsUpCases.value),
                up_pieces: Number(DOM.inputs.goodsUpPieces.value),
                ret_cases: Number(DOM.inputs.goodsRetCases.value),
                ret_pieces: Number(DOM.inputs.goodsRetPieces.value),
            };
        }

        function getSalesData(){
            return {
                cases: Number(DOM.inputs.salesCases.value),
                pieces: Number(DOM.inputs.salesPieces.value)
            }
        }

        /**
            * @param {salesFields} data The data to set the case and piece count.
        */
        function setSalesData(data) { 
            if (data && typeof data === 'object') {
                DOM.inputs.salesCases.value = data.cases;
                DOM.inputs.salesPieces.value = data.pieces;
            } else {
                console.error("Invalid data provided to setCasePieceData");
                DOM.inputs.salesCases.value = "";
                DOM.inputs.salesPieces.value = "";
            }
        }

        function calculateSalesFromReturns() {
            const goodsData = {
                up_cases: Number(DOM.inputs.goodsUpCases.value),   // Initial cases taken
                up_pieces: Number(DOM.inputs.goodsUpPieces.value), // Initial pieces taken
                ret_cases: Number(DOM.inputs.goodsRetCases.value), // Returned cases
                ret_pieces: Number(DOM.inputs.goodsRetPieces.value) // Returned pieces
            };

            // Total pieces initially taken (cases * 24 pieces per case)
            const piecesPerCase = 24;
            const totalUpPieces  = (goodsData.up_cases * piecesPerCase) + goodsData.up_pieces;
            const totalRetPieces = (goodsData.ret_cases * piecesPerCase) + goodsData.ret_pieces;

            const remainingPieces = totalUpPieces - totalRetPieces;

            console.log(remainingPieces)
            
            if (remainingPieces < 0 ){
                alert("You cannot sale more than you taken")

                return ;
            }

            let soldCases  = 0;
            let soldPieces = 0;

            if(remainingPieces % piecesPerCase == 0){
                soldCases = remainingPieces / piecesPerCase; 
            }
            else{
                soldCases = Math.floor(remainingPieces / piecesPerCase);
                soldPieces = remainingPieces % piecesPerCase;
            }
            
            // Return sales data if needed
            return {
                cases: soldCases,
                pieces: soldPieces
            };
        }


        [
            DOM.inputs.goodsRetCases, DOM.inputs.goodsRetPieces, DOM.inputs.goodsUpCases, DOM.inputs.goodsUpPieces
        ].forEach(input => {
            input.addEventListener('input', () => {
                let sales = calculateSalesFromReturns();
                if(!sales){
                    DOM.inputs.goodsRetCases.value = ""
                    return ;
                }
                setSalesData(sales);
                DOM.inputs.salesCases.dispatchEvent(new Event('input'));
            })
        })


        function getSelectedProductFromTodoObject(todo) {
            // Filter products matching both name and size
            const matchingProducts = products.filter(product =>
                product.name.toLowerCase() === todo.title 
                // (product.size === Number(todo.size)) // Match size if provided
            );

            if (matchingProducts.length > 0) {
                return matchingProducts[0]; // Return all matching products
            } else {
                console.warn('No products found for the selected name and size.');
                return null;
            }
        }

        function updateAmount() {
            const selectedProduct = getSelectedProduct();
            if (!selectedProduct) {
                [
                    'salesCases', 'salesPieces', 'discount',
                    'commission', 'kuraivuPieces', 
                    'kuraivuCases', 'adhigaVaravuPieces', 
                    'adhigaVaravuCases', 'amount'
                ].forEach(key => {
                    DOM.inputs[key].value = "";
                });
                return;
            }

            const caseCount = Number(DOM.inputs.salesCases.value);
            const pieceCount = Number(DOM.inputs.salesPieces.value);
            
            // Calculate discount and commission using the new methods
            const discount = calculateDiscounts();
            const commission = calculateCommissions();
            const gains    = calculateGains();
            console.log("toal gain is ")
            console.log(gains)

            DOM.inputs.discount.value = Number(discount);
            DOM.inputs.commission.value = Number(commission);
            // DOM.inputs.gains.value = Number(gains);

            const kuraivu = Number(DOM.inputs.kuraivuPieces.value);
            let totalAmount = (caseCount * selectedProduct.price.case) + 
                             (pieceCount * selectedProduct.price.piece);
            
            totalAmount -= discount;
            totalAmount -= commission;
            totalAmount += gains;
            totalAmount += (kuraivu * selectedProduct.kuraivu);

            DOM.inputs.amount.value = totalAmount.toFixed(2);
        }

        DOM.buttons.productAdd.addEventListener('click', function (e) {
            const driverName = DOM.inputs.driverName.value;
            if (!driverName.trim()) {
                e.preventDefault();
                alert('Please select driver name first');
                DOM.inputs.driverName.classList.add('required-field');
            }
        });

        function updateSummary() {
            let totalBaseAmount = 0;
            let totalDiscounts = 0;
            let totalCommissions = 0;
            let totalGains = 0;  // Initialize total gains
            let totalKuraivu = 0;
            let totalAdhigaVaravu = 0;

            todos.forEach(todo => {
                const productInfo = getSelectedProductFromTodoObject(todo);
                const basePriceCase = productInfo ? productInfo.price.case : 0;
                const basePricePiece = productInfo ? productInfo.price.piece : 0;
                const caseQuantity = Number(todo.cases);
                const pieceQuantity = Number(todo.pieces);

                const baseAmount = (caseQuantity * basePriceCase) + (pieceQuantity * basePricePiece);
                totalBaseAmount += baseAmount;

                totalDiscounts += Number(todo.discount) || 0;
                totalCommissions += Number(todo.commission) || 0;
                totalKuraivu += (Number(todo.kuraivu_pieces) * (productInfo ? productInfo.kuraivu : 0)) || 0;

                // Calculate total gains
                todo.gains.forEach(gain => {
                    totalGains += (gain.cases * gain.size) + (gain.pieces * (gain.size / 24));
                });
            });

            // Include total gains in totalBaseAmount
            totalBaseAmount += totalGains; // Add total gains to totalBaseAmount

            const constantExpenses = getExpensesTotal();
            const creditPayable = Number(DOM.inputs.creditPayable.value) || 0;
            const creditReceivable = Number(DOM.inputs.creditReceivable.value) || 0;

            // Calculate total deductions including credit payable
            const totalDeductions = totalDiscounts + totalCommissions + constantExpenses + creditPayable;

            // Calculate final amount including both credits
            const finalAmount = totalBaseAmount - totalDeductions + totalKuraivu + creditReceivable; // No need to add gains again

            // Update display with detailed breakdown
            DOM.summary.totalProducts.innerHTML = `
                <div class="h5 mb-0">₹${totalBaseAmount.toFixed(2)}</div>
            `;

            DOM.summary.totalDeductions.innerHTML = `
                <div class="h5 mb-0 text-danger">₹${totalDeductions.toFixed(2)}</div>
                <div class="small text-muted">
                    ${totalDiscounts > 0 ? `Discounts: ₹${totalDiscounts.toFixed(2)}<br>` : ''}
                    ${totalCommissions > 0 ? `Commissions: ₹${totalCommissions.toFixed(2)}<br>` : ''}
                    ${constantExpenses > 0 ? `Expenses: ₹${constantExpenses.toFixed(2)}<br>` : ''}
                    ${creditPayable > 0 ? `Credit Payable: ₹${creditPayable.toFixed(2)}<br>` : ''}
                    ${creditReceivable > 0 ? `<span class="text-success">Credit Receivable: +₹${creditReceivable.toFixed(2)}</span><br>` : ''}
                    ${totalGains > 0 ? `<span class="text-success">Gains: +₹${totalGains.toFixed(2)}</span><br>` : ''}  // Display total gains
                </div>
            `;

            DOM.summary.finalAmount.innerHTML = `
                <div class="h4 mb-0 text-primary">₹${finalAmount.toFixed(2)}</div>
            `;
        }

        function updateList() {
            DOM.containers.productList.innerHTML = todos.map(todo => {
                const productInfo = getSelectedProductFromTodoObject(todo);
                const basePrice_case = productInfo ? productInfo.price.case : 0;
                const basePrice_piece = productInfo ? productInfo.price.piece : 0;
                const case_quantity = Number(todo.cases);
                const piece_quantity = Number(todo.pieces);
                const gain = calculateGains();
                const baseAmount = (case_quantity * basePrice_case) + (piece_quantity * basePrice_piece) + gain;
                const totalDeductions = Number(todo.discount) + Number(todo.commission);
                const totalAdditions = Number(todo.kuraivu_pieces) * (productInfo ? productInfo.kuraivu : 0);

                return `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h3 class="mb-0">${todo.title}</h3>
                                <button class="btn btn-link btn-sm text-danger p-0" onclick="deleteTodo(${todo.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            
                            <!-- Basic Information -->
                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <small class="text-muted">Area:</small>
                                    <div>${todo.line}</div>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Quantity:</small>
                                    <div>${todo.cases} cases + ${todo.pieces} pieces</div>
                                </div>
                            </div>

                            <!-- Financial Breakdown -->
                            <div class="border-top pt-2">
                                <div class="row g-2">
                                    <!-- Base Amount -->
                                    <div class="col-12">
                                        <div class="d-flex justify-content-between">
                                            <small class="text-muted">Base Amount:</small>
                                            <div class="fw-bold">₹${baseAmount.toFixed(2)}</div>
                                        </div>
                                    </div>

                                    <!-- Deductions Section -->
                                    <div class="col-12">
                                        <small class="text-muted d-block mb-1">Deductions:</small>
                                        <div class="ms-3">
                                            ${Number(todo.discount) > 0 ? `
                                            <div class="d-flex justify-content-between text-danger">
                                                <span>Discount</span>
                                                <span>-₹${Number(todo.discount).toFixed(2)}</span>
                                            </div>` : ''}
                                            
                                            ${Number(todo.commission) > 0 ? `
                                            <div class="d-flex justify-content-between text-danger">
                                                <span>Commission</span>
                                                <span>-₹${Number(todo.commission).toFixed(2)}</span>
                                            </div>` : ''}
                                            
                                            ${Number(todo.kuraivu) > 0 ? `
                                            <div class="d-flex justify-content-between text-danger">
                                                <span>Kuraivu (${todo.kuraivu} pieces)</span>
                                                <span>-₹${(Number(todo.kuraivu) * (productInfo ? productInfo.price.piece : 0)).toFixed(2)}</span>
                                            </div>` : ''}
                                        </div>
                                    </div>

                                    <!-- Additions Section -->
                                    ${Number(todo.kuraivu_pieces) > 0 ? `
                                    <div class="col-12">
                                        <small class="text-muted d-block mb-1">Additions:</small>
                                        <div class="ms-3">
                                            <div class="d-flex justify-content-between text-success">
                                                <span>Kuraivu (${todo.kuraivu_pieces} pieces)</span>
                                                <span>+₹${totalAdditions.toFixed(2)}</span>
                                            </div>
                                        </div>
                                    </div>` : ''}

                                    <!-- Final Amount -->
                                    <div class="col-12 mt-2 border-top pt-2">
                                        <div class="d-flex justify-content-between">
                                            <small class="text-muted fw-bold">Final Amount:</small>
                                            <div class="text-primary fw-bold">₹${todo.amount}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            DOM.buttons.submit.parentElement.style.visibility = todos.length > 0 ? 'visible' : 'hidden';
            DOM.containers.constantExpenses.style.visibility  = todos.length > 0 ? 'visible' : 'hidden';
            DOM.containers.creditSection.style.visibility     = todos.length > 0 ? 'visible' : 'hidden'; 
            updateSummary();
        }

        function closeModal(modalId) {
            const modalInstance = mdb.Modal.getInstance(DOM.modals.addTodoModal);
            modalInstance.hide();
        }

        // Event listeners for amount calculation
        ['product', 'salesCases', 'salesPieces', 'discount',
            'commission', 'kuraivuPieces']
            .forEach(key => {
                DOM.inputs[key].addEventListener('input', updateAmount);
            });
        

        DOM.inputs.driverName.addEventListener("input", validateFields);
        DOM.inputs.area.addEventListener("input", validateFields);

        function validateFields() {
            const driverName = DOM.inputs.driverName.value.trim();
            const area = DOM.inputs.area.value.trim();

            if (this === DOM.inputs.driverName) {
                DOM.inputs.driverName.classList.remove('required-field');
            } else if (this === DOM.inputs.area) {
                DOM.inputs.area.classList.remove('required-field');
            }

            if (driverName && area) {
                DOM.buttons.productAdd.style.visibility = "visible";
            } else {
                DOM.buttons.productAdd.style.visibility = "hidden";
            }

            if (!driverName) {
                DOM.inputs.driverName.classList.add('required-field');
            }
            if (!area) {
                DOM.inputs.area.classList.add('required-field');
            }
        }

        function addExpenseRow() {
            const newRow = document.createElement('div');
            newRow.className = 'expense-row mb-2 position-relative';
            newRow.innerHTML = `
                <div class="row g-2">
                    <div class="col-8">
                        <div class="form-outline mb-3">
                            <input type="text" class="form-control expense-description active dropdown-toggle" 
                                   data-mdb-dropdown-init aria-expanded="false" autocomplete="off" id="expenseOptions">
                            <label class="form-label">Description</label>
                            <ul class="dropdown-menu w-100" id="expenseDropdown" aria-labelledby="expenseOptions">
                                <li><a class="dropdown-item">Petrol</a></li>
                                <li><a class="dropdown-item">Food</a></li>
                                <li><a class="dropdown-item">Rep</a></li>
                                <li><a class="dropdown-item">Key</a></li>
                                <li><a class="dropdown-item">Vehicle_Repair</a></li>
                                <li><a class="dropdown-item">Gpay</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="form-outline mb-3">
                            <input type="number" class="form-control active expense-amount">
                            <label class="form-label">Amount</label>
                        </div>
                    </div>
                    <div class="col-1">
                        <button class="btn btn-link text-danger p-0" onclick="removeExpenseRow(this)">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;

            DOM.containers.expenses.appendChild(newRow);

            // Initialize MDB elements
            newRow.querySelectorAll('.form-outline').forEach((formOutline) => {
                new mdb.Input(formOutline).init();
            });

            const dropdownInputs = newRow.querySelectorAll('.dropdown-toggle');
            dropdownInputs.forEach(input => {
                new mdb.Dropdown(input);
            });


            // Add event listener for dropdown item click
            const expenseOptionsMenu = newRow.querySelector('#expenseDropdown');
            const expenseOptionInput = newRow.querySelector('#expenseOptions');

            expenseOptionsMenu.addEventListener("click", (e) => {
                if (e.target && e.target.matches('.dropdown-item')) {
                    // Set input value to the clicked item's text content
                    expenseOptionInput.value = e.target.textContent.trim();
                    expenseOptionsMenu.classList.remove('show');
                }
            });
        }



        function removeExpenseRow(button) {
            if (document.querySelectorAll('.expense-row').length > 0) {
                button.closest('.expense-row').remove();
                updateSummary();
            }
        }



        // Modify updateSummary() to handle dynamic expenses
        function getExpensesTotal() {
            let total = 0;
            document.querySelectorAll('.expense-amount').forEach(input => {
                total += parseFloat(input.value) || 0;
            });
            return total;
        }


        // Add event listeners for expense amounts
        document.addEventListener('input', function (e) {
            if (e.target.classList.contains('expense-amount')) {
                updateSummary();
            }
        });


        // Add event listeners for credit inputs
        ['creditPayable', 'creditReceivable'].forEach(id => {
            DOM.inputs[id].addEventListener('input', updateSummary);
        });

        function submitBillingDetails() {
            DOM.buttons.submit.style.visibility = "hidden";

            const expenses = {};
            DOM.containers.expenses.querySelectorAll('.expense-row').forEach(row => {
                const description = row.querySelector('.expense-description').value;
                const amount = parseFloat(row.querySelector('.expense-amount').value) || 0;
                if (description || amount > 0) {
                    expenses[description] = amount;
                }
            });

            const localTime = new Date();
            const timeStr = `${localTime.getHours().toString().padStart(2, '0')}:${localTime.getMinutes().toString().padStart(2, '0')}`;

            const billingEntries = todos.map(todo => {
                return {
                    driver_name: DOM.inputs.driverName.value,
                    date: DOM.inputs.date.value,
                    time: timeStr,
                    product_name: todo.title,
                    line: todo.line,
                    goods_upload_cases: Number(todo.goods_upload_cases) || 0,
                    goods_upload_pieces: Number(todo.goods_upload_pieces) || 0,
                    goods_return_cases: Number(todo.goods_return_cases) || 0,
                    goods_return_pieces: Number(todo.goods_return_pieces) || 0,
                    cases: Number(todo.cases) || 0,
                    pieces: Number(todo.pieces) || 0,
                    discount: todo.discounts,         // Use stored discount entries
                    commission: todo.commissions,     // Use stored commission entries
                    kuraivu_pieces: Number(todo.kuraivu_pieces) || 0,
                    kuraivu_cases: Number(todo.kuraivu_cases) || 0,
                    kuraivu_amount: Number(todo.kuraivu_amount) || 0,
                    adhiga_varavu_cases: Number(todo.adhigaVaravu_cases) || 0,
                    adhiga_varavu_pieces: Number(todo.adhigaVaravu_pieces) || 0,
                    final_amount: Number(todo.amount),
                    base_amount: todo.base_amount
                };
            });

            const payload = {
                entries: billingEntries,
                expenses: expenses,
                credits: {
                    payable: Number(DOM.inputs.creditPayable.value) || 0,
                    receivable: Number(DOM.inputs.creditReceivable.value) || 0
                }
            };

            console.log(payload.entries);

            const isDevelopment = window.location.hostname === 'localhost' || window.location.hostname === "127.0.0.1";
            const baseUrl = isDevelopment ? 'http://localhost:8000/' : 'https://nagaraj1.pythonanywhere.com/';

            // Submit to server
            fetch(baseUrl + "update_sheet", {
                // fetch("https://dharikarsath01.pythonanywhere.com/update_sheet", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                if (!response.ok) {
                    DOM.buttons.submit.style.visibility = 'visible';
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (isDevelopment) {
                    window.location.replace("thankyou.html");
                } else {
                    window.location.replace("thankyou");
                }
            })
            .catch(error => {
                console.error("Error submitting billing details:", error);
                alert("Failed to submit billing details. Please try again.");
                DOM.buttons.submit.style.visibility = 'visible';
            });
        }

        function filterArea(query) {
            return lineListInfo.filter(line => line.line.toLowerCase().includes(query.toLowerCase()));
        }

        // Render all items by default
        function renderLineDropdown() {
            DOM.dropdowns.line.innerHTML = '';  // Clear existing items
            lineListInfo.forEach(line => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `<a class="dropdown-item" href="#">${line.line.toLowerCase()}</a>`;
                DOM.dropdowns.line.appendChild(listItem);
            });
        }

        // // Initial render of all items
        // // renderAllItems();
        DOM.inputs.area.addEventListener("click", () => {
            renderLineDropdown();
        })

        DOM.inputs.area.addEventListener('input', function () {
            const query = DOM.inputs.area.value.trim().toLowerCase();

            if (query.length === 0) {
                renderLineDropdown(); // Show all items if no input
                return;
            }

            const matches = filterArea(query);
            DOM.dropdowns.line.innerHTML = '';  // Clear the dropdown

            matches.forEach(match => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `<a class="dropdown-item" href="#">${match.line}</a>`;
                DOM.dropdowns.line.appendChild(listItem);
            });
        });

        // Handle dropdown item selection
        DOM.dropdowns.line.addEventListener('click', function (e) {
            if (e.target && e.target.matches('.dropdown-item')) {
                DOM.inputs.area.value = e.target.textContent.trim();
                DOM.dropdowns.line.innerHTML = '';  // Close dropdown after selection

                DOM.inputs.area.dispatchEvent(new Event('input'));
            }
        });


















        function filterDrivers(query) {
            return driverListInfo.filter(driver => driver.name.toLowerCase().includes(query.toLowerCase()));
        }

        // Render all items by default
        function renderDriversDropdown() {
            DOM.dropdowns.driver.innerHTML = '';  // Clear existing items
            driverListInfo.forEach(driver => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `<a class="dropdown-item" href="#">${driver.name.toLowerCase()}</a>`;
                DOM.dropdowns.driver.appendChild(listItem);
            });
        }

        // // Initial render of all items
        // // renderAllItems();
        DOM.inputs.driverName.addEventListener("click", () => {
            renderDriversDropdown();
        })

        DOM.inputs.driverName.addEventListener('input', function () {
            const query = DOM.inputs.driverName.value.trim().toLowerCase();

            if (query.length === 0) {
                renderDriversDropdown(); // Show all items if no input
                return;
            }

            const matches = filterDrivers(query);
            console.log(matches)
            DOM.dropdowns.driver.innerHTML = '';  // Clear the dropdown

            matches.forEach(match => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `<a class="dropdown-item" href="#">${match.name}</a>`;
                DOM.dropdowns.driver.appendChild(listItem);
            });
        });

        // Handle dropdown item selection
        DOM.dropdowns.driver.addEventListener('click', function (e) {
            if (e.target && e.target.matches('.dropdown-item')) {
                DOM.inputs.driverName.value = e.target.textContent.trim();
                DOM.dropdowns.driver.innerHTML = '';  // Close dropdown after selection

                DOM.inputs.driverName.dispatchEvent(new Event('input'));
            }
        });



        function renderSizesForSelectedProduct() {
            DOM.dropdowns.productSize.innerHTML = '';
            const selectedProductName = DOM.inputs.product.value.toLowerCase();
            const uniqueSizes = new Set();

            // Filter sizes for the chosen product
            products
                .filter(product => product.name.toLowerCase() === selectedProductName)
                .forEach(product => {
                    const size = product.size;
                    if (!uniqueSizes.has(size)) {
                        uniqueSizes.add(size);

                        const listItem = document.createElement('li');
                        listItem.innerHTML = `<a class="dropdown-item" href="#">${size}</a>`;
                        DOM.dropdowns.productSize.appendChild(listItem);
                    }
                });
        }

        // // Attach an event listener to the size input
        // DOM.inputs.productSize.addEventListener("click", () => {
        //     renderSizesForSelectedProduct();
        // });



        // Handle dropdown item selection
        // DOM.dropdowns.productSize.addEventListener('click', function (e) {
        //     if (e.target && e.target.matches('.dropdown-item')) {
        //         DOM.inputs.productSize.value = e.target.textContent.trim();
        //         DOM.dropdowns.productSize.innerHTML = '';  // Close dropdown after selection
        //         DOM.inputs.productSize.dispatchEvent(new Event('input'));
        //     }
        // });

        function addDiscountRow() {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'discount-row mb-3';
            
            rowDiv.innerHTML = `
                <div class="row g-2">
                    <div class="col-3">
                        <div class="form-outline">
                            <input type="text" class="form-control active dropdown-toggle discount-size" 
                                data-mdb-dropdown-init aria-expanded="false" autocomplete="off">
                            <label class="form-label">Size</label>
                            <ul class="dropdown-menu w-100 discount-size-dropdown">
                            </ul>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="form-outline">
                            <input type="number" class="form-control active discount-cases" min="0">
                            <label class="form-label">Cases</label>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="form-outline">
                            <input type="number" class="form-control active discount-pieces" min="0" max="24">
                            <label class="form-label">Pieces</label>
                        </div>
                    </div>
                    <div class="col-3 d-flex align-items-center">
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeDiscountRow(this)">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
            
            DOM.containers.discounts.appendChild(rowDiv);
            
            // Initialize MDB form elements
            rowDiv.querySelectorAll('.form-outline').forEach((formOutline) => {
                new mdb.Input(formOutline).init();
            });

            const sizeInput = rowDiv.querySelector('.discount-size');
            const dropdownMenu = rowDiv.querySelector('.discount-size-dropdown');
            
            sizeInput.addEventListener('click', () => {
                renderDiscountSizes(dropdownMenu);
            });

            dropdownMenu.addEventListener('click', function(e) {
                if (e.target && e.target.matches('.dropdown-item')) {
                    sizeInput.value = e.target.textContent.trim();
                    dropdownMenu.innerHTML = '';
                    sizeInput.dispatchEvent(new Event('input'));
                }
            });

            // Add event listeners for amount calculation
            const discountInputs = rowDiv.querySelectorAll('.discount-size, .discount-cases, .discount-pieces');
            discountInputs.forEach(input => {
                input.addEventListener('input', updateAmount);
            });

            const dropdownInputs = rowDiv.querySelectorAll('.dropdown-toggle');
            dropdownInputs.forEach(input => {
                new mdb.Dropdown(input);
            });
        }



        function addGainRow() {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'gain-row mb-3';
            
            rowDiv.innerHTML = `
                <div class="row g-2">
                    <div class="col-3">
                        <div class="form-outline">
                            <input type="text" class="form-control active dropdown-toggle gain-size" 
                                data-mdb-dropdown-init aria-expanded="false" autocomplete="off">
                            <label class="form-label">Size</label>
                            <ul class="dropdown-menu w-100 gain-size-dropdown">
                            </ul>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="form-outline">
                            <input type="number" class="form-control active gain-cases" min="0">
                            <label class="form-label">Cases</label>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="form-outline">
                            <input type="number" class="form-control active gain-pieces" min="0" max="24">
                            <label class="form-label">Pieces</label>
                        </div>
                    </div>
                    <div class="col-3 d-flex align-items-center">
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeGainRow(this)">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
            
            DOM.containers.gains.appendChild(rowDiv);
            
            // Initialize MDB form elements
            rowDiv.querySelectorAll('.form-outline').forEach((formOutline) => {
                new mdb.Input(formOutline).init();
            });

            const sizeInput = rowDiv.querySelector('.gain-size');
            const dropdownMenu = rowDiv.querySelector('.gain-size-dropdown');
            
            sizeInput.addEventListener('click', () => {
                renderGainSizes(dropdownMenu);  // Using renderDiscountSizes directly
            });

            dropdownMenu.addEventListener('click', function(e) {
                if (e.target && e.target.matches('.dropdown-item')) {
                    sizeInput.value = e.target.textContent.trim();
                    dropdownMenu.innerHTML = '';
                    sizeInput.dispatchEvent(new Event('input'));
                }
            });

            // Add event listeners for amount calculation
            const gainInputs = rowDiv.querySelectorAll('.gain-size, .gain-cases, .gain-pieces');
            gainInputs.forEach(input => {
                input.addEventListener('input', updateAmount);
            });

            const dropdownInputs = rowDiv.querySelectorAll('.dropdown-toggle');
            dropdownInputs.forEach(input => {
                new mdb.Dropdown(input);
            });
        }


        function removeGainRow(button) {
            const rowToRemove = button.closest('.gain-row');
            rowToRemove.remove();
            updateAmount();
        }


        function renderGainSizes(dropdownMenu) {
                dropdownMenu.innerHTML = '';
                const selectedProductName = DOM.inputs.product.value.toLowerCase();
                const uniqueSizes = new Set();

                // Filter sizes for the chosen product
                products
                    .filter(product => product.name.toLowerCase() === selectedProductName)
                    .forEach(product => {
                        const size = product.gain.case;
                        if (!uniqueSizes.has(size)) {
                            uniqueSizes.add(size);
                            const listItem = document.createElement('li');
                            listItem.innerHTML = `<a class="dropdown-item" href="#">${size}</a>`;
                            dropdownMenu.appendChild(listItem);
                        }
                    });
            }


        
        function renderDiscountSizes(dropdownMenu) {
            dropdownMenu.innerHTML = '';
            const selectedProductName = DOM.inputs.product.value.toLowerCase();
            const uniqueSizes = new Set();

            // Filter sizes for the chosen product
            products
                .filter(product => product.name.toLowerCase() === selectedProductName)
                .forEach(product => {
                    const size = product.discount.case;
                    if (!uniqueSizes.has(size)) {
                        uniqueSizes.add(size);
                        const listItem = document.createElement('li');
                        listItem.innerHTML = `<a class="dropdown-item" href="#">${size}</a>`;
                        dropdownMenu.appendChild(listItem);
                    }
                });
        }

        function calculateGains() {
            const gainRows = document.querySelectorAll('.gain-row');
            let totalGain = 0;
            const selectedProduct = getSelectedProduct();
            console.log(selectedProduct)
            
            if (!selectedProduct) return 0;
            
            gainRows.forEach(row => {
                const size = row.querySelector('.gain-size').value;
                const cases = parseInt(row.querySelector('.gain-cases').value) || 0;
                const pieces = parseInt(row.querySelector('.gain-pieces').value) || 0;
                
                // Find the product with matching size
                const productWithSize = products.find(p => 
                    p.name.toLowerCase() === selectedProduct.name.toLowerCase() &&
                    p.gain.case === Number(size)
                )

                totalGain += (cases * productWithSize.gain.case) + (pieces * productWithSize.gain.piece);
            });
            
            return totalGain;
        }

        function calculateDiscounts() {
            const discountRows = document.querySelectorAll('.discount-row');
            let totalDiscount = 0;
            const selectedProduct = getSelectedProduct();
            
            if (!selectedProduct) return 0;
            
            discountRows.forEach(row => {
                const size = row.querySelector('.discount-size').value;
                const cases = parseInt(row.querySelector('.discount-cases').value) || 0;
                const pieces = parseInt(row.querySelector('.discount-pieces').value) || 0;
                
                // Find the product with matching size
                const productWithSize = products.find(p => 
                    p.name.toLowerCase() === selectedProduct.name.toLowerCase() && 
                    p.discount.case === Number(size)
                );
                console.log(productWithSize)
                
                if (productWithSize) {
                    totalDiscount += (cases * productWithSize.discount.case) + 
                                   (pieces * productWithSize.discount.piece);
                        
                    console.log(totalDiscount);
                }

            });
            
            return totalDiscount;
        }

        function removeDiscountRow(button) {
            const row = button.closest('.discount-row');
            row.remove();
            updateAmount();
        }

        function saveTodo() {
            const isProductEmpty = DOM.inputs.product.value.trim() === '';
            if (isProductEmpty) return;

            const selectedProduct = getSelectedProduct();
            const goodsData = getGoodsData();
            const totalQuantityCases = Number(DOM.inputs.salesCases.value);
            const totalQuantityPieces = Number(DOM.inputs.salesPieces.value);

            if (totalQuantityCases === 0 && totalQuantityPieces === 0) return;

            // Collect discount entries
            const discountEntries = [];
            DOM.containers.discounts.querySelectorAll('.discount-row').forEach(row => {
                discountEntries.push({
                    size: Number(row.querySelector('.discount-size').value),
                    cases: Number(row.querySelector('.discount-cases').value) || 0,
                    pieces: Number(row.querySelector('.discount-pieces').value) || 0
                });
            });

            // Collect commission entries
            const commissionEntries = [];
            DOM.containers.commissions.querySelectorAll('.commission-row').forEach(row => {
                commissionEntries.push({
                    size: Number(row.querySelector('.commission-size').value),
                    cases: Number(row.querySelector('.commission-cases').value) || 0,
                    pieces: Number(row.querySelector('.commission-pieces').value) || 0
                });
            });

            // Collect gain entries
            const gainEntries = [];
            DOM.containers.gains.querySelectorAll('.gain-row').forEach(row => {
                gainEntries.push({
                    size: Number(row.querySelector('.gain-size').value),
                    cases: Number(row.querySelector('.gain-cases').value) || 0,
                    pieces: Number(row.querySelector('.gain-pieces').value) || 0
                });
            });

            const baseAmount = (totalQuantityCases * selectedProduct.price.case) + 
                              (totalQuantityPieces * selectedProduct.price.piece);

            // Calculate total gains
            let totalGains = 0;
            gainEntries.forEach(gain => {
                totalGains += (gain.cases * gain.size) + (gain.pieces * (gain.size / 24));
            });

            // Add total gains to base amount
            const finalBaseAmount = baseAmount + totalGains;

            const kuraivuAmount = DOM.inputs.kuraivuPieces.value * selectedProduct.kuraivu;

            const formData = {
                title: DOM.inputs.product.value,
                line: DOM.inputs.area.value,
                cases: DOM.inputs.salesCases.value || 0,
                pieces: DOM.inputs.salesPieces.value || 0,
                discount: DOM.inputs.discount.value,
                goods_upload_cases: goodsData.up_cases,
                goods_upload_pieces: goodsData.up_pieces,
                goods_return_cases: goodsData.ret_cases,
                goods_return_pieces: goodsData.ret_pieces,
                commission: DOM.inputs.commission.value,
                kuraivu_pieces: DOM.inputs.kuraivuPieces.value || 0,
                kuraivu_cases: DOM.inputs.kuraivuCases.value || 0,
                kuraivu_amount: kuraivuAmount,
                adhigaVaravu_cases: DOM.inputs.adhigaVaravuCases.value || 0,
                adhigaVaravu_pieces: DOM.inputs.adhigaVaravuPieces.value || 0,
                amount: DOM.inputs.amount.value,
                base_amount: finalBaseAmount,  // Update base amount to include gains
                discounts: discountEntries,        // Store discount entries
                commissions: commissionEntries,    // Store commission entries
                gains: gainEntries                 // Store gain entries
            };

            if (formData.title) {
                todos.push({ id: currentId++, ...formData });
                updateList();
                DOM.forms.todo.reset();
                closeModal('addTodoModal');
            }
        }

        function addCommissionRow() {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'commission-row mb-3';
            
            rowDiv.innerHTML = `
                <div class="row g-2">
                    <div class="col-3">
                        <div class="form-outline">
                            <input type="text" class="form-control active dropdown-toggle commission-size" 
                                data-mdb-dropdown-init aria-expanded="false" autocomplete="off">
                            <label class="form-label">Size</label>
                            <ul class="dropdown-menu w-100 commission-size-dropdown">
                            </ul>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="form-outline">
                            <input type="number" class="form-control active commission-cases" min="0">
                            <label class="form-label">Cases</label>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="form-outline">
                            <input type="number" class="form-control active commission-pieces" min="0" max="24">
                            <label class="form-label">Pieces</label>
                        </div>
                    </div>
                    <div class="col-3 d-flex align-items-center">
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeCommissionRow(this)">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
            
            DOM.containers.commissions.appendChild(rowDiv);
            
            // Initialize MDB form elements
            rowDiv.querySelectorAll('.form-outline').forEach((formOutline) => {
                new mdb.Input(formOutline).init();
            });

            const sizeInput = rowDiv.querySelector('.commission-size');
            const dropdownMenu = rowDiv.querySelector('.commission-size-dropdown');
            
            sizeInput.addEventListener('click', () => {
                renderCommissionSizes(dropdownMenu);
            });

            dropdownMenu.addEventListener('click', function(e) {
                if (e.target && e.target.matches('.dropdown-item')) {
                    sizeInput.value = e.target.textContent.trim();
                    dropdownMenu.innerHTML = '';
                    sizeInput.dispatchEvent(new Event('input'));
                }
            });

            // Add event listeners for amount calculation
            const commissionInputs = rowDiv.querySelectorAll('.commission-size, .commission-cases, .commission-pieces');
            commissionInputs.forEach(input => {
                input.addEventListener('input', updateAmount);
            });

            const dropdownInputs = rowDiv.querySelectorAll('.dropdown-toggle');
            dropdownInputs.forEach(input => {
                new mdb.Dropdown(input);
            });
        }

        function renderCommissionSizes(dropdownMenu) {
            dropdownMenu.innerHTML = '';
            const selectedProductName = DOM.inputs.product.value.toLowerCase();
            const uniqueSizes = new Set();

            products
                .filter(product => product.name.toLowerCase() === selectedProductName)
                .forEach(product => {
                    const size = product.commission.case;
                    if (!uniqueSizes.has(size)) {
                        uniqueSizes.add(size);
                        const listItem = document.createElement('li');
                        listItem.innerHTML = `<a class="dropdown-item" href="#">${size}</a>`;
                        dropdownMenu.appendChild(listItem);
                    }
                });
        }

        function calculateCommissions() {
            const commissionRows = document.querySelectorAll('.commission-row');
            let totalCommission = 0;
            const selectedProduct = getSelectedProduct();
            
            if (!selectedProduct) return 0;
            
            commissionRows.forEach(row => {
                const size = row.querySelector('.commission-size').value;
                const cases = parseInt(row.querySelector('.commission-cases').value) || 0;
                const pieces = parseInt(row.querySelector('.commission-pieces').value) || 0;
                
                // Find the product with matching size
                const productWithSize = products.find(p => 
                    p.name.toLowerCase() === selectedProduct.name.toLowerCase() && 
                    p.commission.case === Number(size)
                );
                
                if (productWithSize) {
                    totalCommission += (cases * productWithSize.commission.case) + 
                                     (pieces * productWithSize.commission.piece);
                }
            });
            
            return totalCommission;
        }

        function removeCommissionRow(button) {
            const row = button.closest('.commission-row');
            row.remove();
            updateAmount();
        }

        // Update product selection handler
        DOM.dropdowns.product.addEventListener('click', function(e) {
            if (e.target && e.target.matches('.dropdown-item')) {
                const newProductName = e.target.textContent.trim();
                const currentProductName = DOM.inputs.product.value.trim();
                
                // Only clear if selecting a different product
                if (newProductName !== currentProductName) {
                    DOM.forms.todo.reset();
                    DOM.containers.discounts.innerHTML = '';  // Clear discount rows
                    DOM.containers.commissions.innerHTML = ''; // Clear commission rows
                }
                
                // Set the new product
                const productId = e.target.dataset.productId;
                DOM.inputs.product.value = newProductName;
                DOM.inputs.product.dataset.productId = productId;
                
                DOM.dropdowns.product.innerHTML = '';
                DOM.inputs.product.dispatchEvent(new Event('input'));
            }
        });

        function deleteTodo(id) {
            todos = todos.filter(todo => todo.id !== id);
            updateList();
        }
    </script>





    <script>
        // TrieNode and Trie implementation
        class TrieNode {
            constructor() {
                this.children = {};
                this.isEndOfWord = false;
            }
        }

        class Trie {
            constructor() {
                this.root = new TrieNode();
            }

            insert(word) {
                let node = this.root;
                for (let char of word) {
                    if (!node.children[char]) {
                        node.children[char] = new TrieNode();
                    }
                    node = node.children[char];
                }
                node.isEndOfWord = true;
            }

            findWordsWithPrefix(prefix) {
                let node = this.root;
                for (let char of prefix) {
                    if (!node.children[char]) {
                        return [];
                    }
                    node = node.children[char];
                }
                return this._collectWords(node, prefix);
            }

            _collectWords(node, prefix) {
                let words = [];
                if (node.isEndOfWord) {
                    words.push(prefix);
                }
                for (let char in node.children) {
                    words = words.concat(this._collectWords(node.children[char], prefix + char));
                }
                return words;
            }
        }

        // Initialize the Trie and insert products
        // const products2 = ["product 1", "product 2", "product 3", "product 4", "other products"];
        const trie = new Trie();
        products.forEach(product => {
            trie.insert(product.name.toLowerCase())
        }
        );

        // Handle user input and update dropdown
        const input = DOM.inputs.product;
        const dropdownMenu = DOM.dropdowns.product;

        // Render all items by default
        function renderAllItems() {
            dropdownMenu.innerHTML = ''; // Clear existing items

            // Use a Set to keep track of unique product names
            const uniqueProductNames = new Set();

            products.forEach(product => {
                const lowerCaseName = product.name.toLowerCase();

                if (!uniqueProductNames.has(lowerCaseName)) {
                    uniqueProductNames.add(lowerCaseName);

                    const listItem = document.createElement('li');
                    listItem.innerHTML = `<a class="dropdown-item" href="#">${lowerCaseName}</a>`;
                    dropdownMenu.appendChild(listItem);
                }
            });
        }

        // Initial render of unique items
        input.addEventListener("click", () => {
            renderAllItems();
        });


        input.addEventListener('input', function() {
            const query = DOM.inputs.product.value.trim().toLowerCase();

            if (query.length === 0) {
                renderAllItems();
                return;
            }

            const matches = trie.findWordsWithPrefix(query);
            DOM.dropdowns.product.innerHTML = '';

            matches.forEach(match => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `<a class="dropdown-item" href="#">${match}</a>`;
                DOM.dropdowns.product.appendChild(listItem);
            });
        });

        // Handle dropdown item selection
        DOM.dropdowns.product.addEventListener('click', function(e) {
            if (e.target && e.target.matches('.dropdown-item')) {
                DOM.inputs.product.value = e.target.textContent.trim();
                DOM.dropdowns.product.innerHTML = '';  // Close dropdown after selection
                DOM.inputs.product.dispatchEvent(new Event('input'));
            }
        });

    </script>


</body>

</html>